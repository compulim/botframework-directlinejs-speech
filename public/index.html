<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>DirectLineJS Speech</title>
    <script src="web-speech-cognitive-services.development.js"></script>
    <script src="directlinespeech.js"></script>
    <script src="webchat.js"></script>
    <style type="text/css">
    body, html, #webchat { height: 100%; }

    body {
      background-color: #F7F7F7;
      margin: 0;
    }

    #webchat {
      box-shadow: 0 0 10px rgba(0, 0, 0, .1);
      margin: 0 auto;
      min-width: 320px;
      max-width: 480px;
    }
    </style>
  </head>
  <body>
    <div id="webchat"></div>
    <script>
      'use strict';

      const DIRECT_LINE_SPEECH_TOKEN_URL = 'https://webchat-waterbottle.azurewebsites.net/token/directlinespeech';
      const SPEECH_SERVICES_AUTHORIZATION_TOKEN_URL = 'https://webchat-waterbottle.azurewebsites.net/token/speechservices';
      const { DirectLineSpeech, WebChat } = window;

      async function fetchJSON(url, options) {
        const res = await fetch(
          url,
          {
            headers: {
              accept: 'application/json'
            },
            ...options
          }
        );

        if (res.ok) {
          return await res.json();
        } else {
          throw new Error(`Failed to fetch JSON, server returned ${ res.status }.`);
        }
      }

      async function fetchDirectLineToken() {
        const res = await fetch(
          DIRECT_LINE_SPEECH_TOKEN_URL,
          {
            headers: {
              accept: 'application/json'
            }
          }
        );
      }

      async function fetchDirectLineSpeechToken() {
        return (await fetchJSON(DIRECT_LINE_SPEECH_TOKEN_URL)).token;
      }

      async function fetchSpeechServicesRegion() {
        return (await fetchJSON(SPEECH_SERVICES_AUTHORIZATION_TOKEN_URL)).region;
      }

      async function fetchSpeechServicesToken() {
        return (await fetchJSON(SPEECH_SERVICES_AUTHORIZATION_TOKEN_URL)).token;
      }

      async function fetchEnvironmentFile() {
        const res = await fetch('/.env');
        const lines = await res.text();

        return lines.split('\n').map(line => line.trim()).filter(line => line && !/^#/.test(line)).reduce((env, line) => {
          const tokens = line.split('=');
          const [key, ...values] = tokens;

          return {
            ...env,
            [key]: values.join('=')
          };
        }, {});
      }

      (async function () {
        const urlSearchParams = new URLSearchParams(document.location.search);
        const secret = urlSearchParams.get('s');
        const speechServicesRegion = urlSearchParams.get('sr');
        const speechServicesSubscriptionKey = urlSearchParams.get('ss');

        // const {
        //   secret: DIRECT_LINE_SPEECH_SECRET,
        //   speechServicesRegion: SPEECH_SERVICES_REGION,
        //   speechServicesSubscriptionKey: SPEECH_SERVICES_SUBSCRIPTION_KEY
        // } = await fetchEnvironmentFile();

        // const token = await fetchDirectLineSpeechToken();

        // const {
        //   region: speechServicesRegion,
        //   token: speechServicesAuthorizationToken
        // } = await fetchSpeechServicesToken();

        // console.log({
        //   secret,
        //   speechServicesRegion,
        //   speechServicesSubscriptionKey
        // });

        const { directLine, webSpeechPonyfillFactory } = window.DirectLine.create({
          secret,
          // speechServicesAuthorizationToken,
          speechServicesRegion,
          speechServicesSubscriptionKey
        });

        WebChat.renderWebChat({
          // directLine: new DirectLineSpeech({
          //   secret,
          //   // speechServicesAuthorizationToken,
          //   speechServicesRegion,
          //   speechServicesSubscriptionKey
          // })
          directLine,
          webSpeechPonyfillFactory
        }, document.getElementById('webchat'));
      }()).catch(err => console.error(err));
    </script>
  </body>
</html>
